<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Homework Checklist</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e6edf3; --muted:#9da7b3; --card:#111823; --line:#223043; --accent:#7ee787; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, sans-serif;
      background:var(--bg); color:var(--fg); }
    header{ padding:16px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,15,20,.9); backdrop-filter: blur(8px);}
    h1{ font-size:16px; margin:0 0 4px 0; }
    .sub{ font-size:12px; color:var(--muted); }
    main{ padding:14px 12px 40px; max-width: 900px; margin:0 auto; }
    .group{ margin:14px 0; background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; }
    .group h2{ font-size:14px; margin:0; padding:12px 12px; border-bottom:1px solid var(--line); }
    .item{ display:flex; gap:10px; padding:10px 12px; border-top:1px solid rgba(34,48,67,.55); align-items:flex-start; }
    .item:first-child{ border-top:none; }
    .title{ font-size:14px; line-height:1.35; }
    .meta{ font-size:12px; color:var(--muted); margin-top:3px; }
    a{ color: #79c0ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    input[type=checkbox]{ width:18px; height:18px; margin-top:2px; accent-color: var(--accent); }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius: 999px; font-size:11px; color:var(--muted); margin-right:6px; }
    .due{ color:#ffb86c; }
    .nodue{ color:#9da7b3; }
    .error{ color:#ff7b72; white-space:pre-wrap; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
      <div>
        <h1>숙제 체크리스트</h1>
        <div class="sub" id="classroomTop"></div>
        <div class="sub" id="lastUpdated">로딩중…</div>
      </div>
      <div class="sub" id="dayNav" style="max-width: 210px; text-align:right; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;"></div>
    </div>
  </header>
  <main>
    <div id="app"></div>
    <div class="sub" style="margin-top:12px;">체크 상태는 이 기기(브라우저)에만 저장돼요.</div>
  </main>
<script>
const STORAGE_KEY = 'zc_done_v1';

function loadDone(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); } catch { return {}; }
}
function saveDone(done){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(done));
}
function fmtKst(iso){
  if (!iso) return null;
  const d = new Date(iso);
  return new Intl.DateTimeFormat('ko-KR', { timeZone:'Asia/Seoul', month:'numeric', day:'numeric', weekday:'short', hour:'2-digit', minute:'2-digit' }).format(d);
}
function kstDayKey(d){
  // YYYY-MM-DD in Asia/Seoul
  const parts = new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Seoul', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(d);
  const y = parts.find(p=>p.type==='year').value;
  const m = parts.find(p=>p.type==='month').value;
  const da = parts.find(p=>p.type==='day').value;
  return `${y}-${m}-${da}`;
}
function escapeHtml(s){
  return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
}

async function main(){
  const app = document.getElementById('app');
  const lastUpdated = document.getElementById('lastUpdated');
  const dayNav = document.getElementById('dayNav');
  const done = loadDone();

  let manifest;
  try {
    const res = await fetch('./days/index.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch days/index.json: ' + res.status);
    manifest = await res.json();
  } catch (e) {
    app.innerHTML = `<div class="error">${String(e.stack || e)}</div>`;
    return;
  }

  const url = new URL(location.href);
  const dayParam = url.searchParams.get('day');
  const todayKey = kstDayKey(new Date());
  const available = new Set((manifest.days || []).map(d => d.day));

  // Default: show today (only today's created/updated items)
  const activeDay = (dayParam && available.has(dayParam)) ? dayParam : (available.has(todayKey) ? todayKey : manifest.latestDay);

  // Render day links (last 14 days only) using date labels (YYYY.MM.DD)
  function addDaysKst(baseKey, delta) {
    const [y,m,d] = baseKey.split('-').map(Number);
    const utc = Date.UTC(y, m-1, d, 0, 0, 0);
    const kstMs = utc + (9*60*60*1000) + delta*24*60*60*1000;
    return kstDayKey(new Date(kstMs));
  }

  const labelMap = new Map((manifest.days || []).map(d => [d.day, d.label || d.day]));

  const links = [];
  for (let i=0; i<14; i++) {
    const k = addDaysKst(todayKey, -i);
    if (!available.has(k)) continue;
    links.push({ day: k, label: labelMap.get(k) || k, isActive: k === activeDay });
  }

  dayNav.innerHTML = links.map(d => {
    const href = `?day=${encodeURIComponent(d.day)}`;
    return `<a href="${href}" style="${d.isActive?'color:#7ee787; text-decoration:underline;':''}">${escapeHtml(d.label)}</a>`;
  }).join('');

  let data;
  try {
    const res = await fetch(`./days/${activeDay}.json`, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch day data: ' + res.status);
    data = await res.json();
  } catch (e) {
    app.innerHTML = `<div class="error">${String(e.stack || e)}</div>`;
    return;
  }

  // Top classroom link
  const classroomTop = document.getElementById('classroomTop');
  const firstLink = (data.groups || []).find(g => g.link)?.link;
  classroomTop.innerHTML = firstLink ? `<a href="${firstLink}" target="_blank" rel="noopener noreferrer">Google Classroom 열기</a>` : '';

  if (data.generatedAt) {
    const t = new Date(data.generatedAt);
    lastUpdated.textContent = `선택 날짜: ${activeDay} · 마지막 갱신: ` + new Intl.DateTimeFormat('ko-KR', { timeZone:'Asia/Seoul', dateStyle:'medium', timeStyle:'short' }).format(t);
  } else {
    lastUpdated.textContent = `선택 날짜: ${activeDay}`;
  }

  const groups = data.groups || [];
  if (!groups.length || !groups.some(g => (g.items||[]).length)) {
    app.innerHTML = `<div class="sub">이 날에는 표시할 숙제가 없어요.</div>`;
    return;
  }

  app.innerHTML = '';

  for (const g of groups) {
    const items = g.items || [];
    if (!items.length) continue;

    const box = document.createElement('section');
    box.className = 'group';

    const h = document.createElement('h2');
    const ha = document.createElement('a');
    ha.href = (g.link || '#');
    ha.target = '_blank';
    ha.rel = 'noopener noreferrer';
    ha.textContent = g.name;
    h.appendChild(ha);
    box.appendChild(h);

    for (const it of items) {
      const row = document.createElement('div');
      row.className = 'item';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!done[it.id];
      cb.addEventListener('change', () => {
        done[it.id] = cb.checked ? 1 : 0;
        saveDone(done);
      });

      const content = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'title';
      const a = document.createElement('a');
      a.href = it.link || '#';
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = it.title || '(제목 없음)';
      title.appendChild(a);

      // Show full combined text (when available) without breaking the compact layout.
      if (it.details) {
        const dwrap = document.createElement('details');
        dwrap.style.marginTop = '6px';

        const sum = document.createElement('summary');
        sum.className = 'meta';
        sum.style.cursor = 'pointer';
        sum.textContent = '내용 보기';

        const body = document.createElement('div');
        body.className = 'meta';
        body.style.whiteSpace = 'pre-wrap';
        body.style.marginTop = '6px';
        body.textContent = it.details;

        dwrap.appendChild(sum);
        dwrap.appendChild(body);
        content.appendChild(dwrap);
      }

      const meta = document.createElement('div');
      meta.className = 'meta';

      const dueText = fmtKst(it.dueAt);
      meta.innerHTML = `${it.topic ? `<span class="pill">${it.topic}</span>` : ''}`
        + `${dueText ? `<span class="pill due">마감 ${dueText}</span>` : `<span class="pill nodue">마감 없음</span>`}`;

      content.appendChild(title);
      content.appendChild(meta);

      row.appendChild(cb);
      row.appendChild(content);
      box.appendChild(row);
    }

    app.appendChild(box);
  }
}

main();
</script>
</body>
</html>
